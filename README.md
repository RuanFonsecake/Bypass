# FHIR Access Proxy

This is a simple access-control proxy that sits in front of a FHIR store (e.g.,
a HAPI FHIR server, GCP FHIR store, etc.) and controls access to the FHIR data.

The seed for this repository was taken from the
[hapi-fhirstarters-simple-server](
https://github.com/FirelyTeam/fhirstarters/tree/master/java/hapi-fhirstarters-simple-server)
part of the [FirelyTeam/fhirstarters](https://github.com/FirelyTeam/fhirstarters)
GitHub repository.

Currently this is mostly a proof-of-concept and a work in progress,
implementing ideas in [go/fhir-access-proxy](go/fhir-access-proxy).


# How to run this proxy

First we need to set the followings as the proxy configuration:
* The location of the FHIR store; this comes from `${PROXY_TO}` environment variable, e.g.,:
  ```shell
  $ export PROXY_TO=https://healthcare.googleapis.com/v1/projects/fhir-sdk/locations/us-central1/datasets/apigee-test-data/fhirStores/apigee-FHIR-store/fhir
  ```
  The above example store is created based on a few hundreds fake patient data
  generated by the
  [OpenMRS demo-data module](https://github.com/openmrs/openmrs-module-referencedemodata)
  and imported to this GCP FHIR store by
  [openmrs-fhir-analytics](https://github.com/GoogleCloudPlatform/openmrs-fhir-analytics)
  batch pipeline.


* The access token issuer; this comes from `${TOKEN_ISSUER}` variable, e.g.,:
  ```shell
  $ export TOKEN_ISSUER=http://35-224-71-179.nip.io/auth/realms/test
  ```
  The above example is a test authentication server based on
  [Keycloak](https://github.com/Alvearie/keycloak-extensions-for-fhir) and
  has a single test user in its `test` realm. 
  Note this is not a secure server (hence no `https`) and is purely set up for
  test purposes.


* The service account to be used to access the FHIR store, if it is a 
  GCP FHIR store. To set this, a key for that service account can be generated
  and downloaded. In the above example `fhir-sdk` project, the `smart-proxy-account`
  service account is created for this purpose. If you have access to this project,
  create a key and:
  ```shell
  $ export GOOGLE_APPLICATION_CREDENTIALS="PATH_TO_THE_JSON_KEY_FILE"
  ```

Once you have set all of the above, then you can run the proxy server by:
```shell
mvn jetty:run -Djetty.http.port=8081
```
which runs the server on port 8081.


# How to use this proxy

Once the proxy is running, we first need to fetch an access token from the
`${TOKEN_ISSUER}`; you should know the test username and password plus the
`client_id` (please disregard `scope` for now):
```shell
$ curl -X POST -d 'client_id=CLIENT_ID' -d 'username=USER' -d 'password=PASS' \
  -d 'grant_type=password' -d 'scope=patient/*.read' \
  "http://35-224-71-179.nip.io/auth/realms/test/protocol/openid-connect/token"
```
we need the `access_token` of the returned JSON to be able to convince the proxy
to authorize our FHIR requests (note there is also a `refresh_token` in the
above response). Here is a simple way to automate this:
```shell
$ export ACCESS_TOKEN=$(curl -X POST -d 'client_id=CLIENT_ID' -d 'username=USER' \
  -d 'password=PASS' -d 'grant_type=password' -d 'scope=patient/*.read' \
  "http://35-224-71-179.nip.io/auth/realms/test/protocol/openid-connect/token" | \
   python3 -m json.tool | awk '/access_token/{gsub(/"|,/, "", $2); print $2;}')
```
with this done, you can access the FHIR store as you wish (the only restriction
beyond having a valid `access_token` is that the user should be in the
`fhirUser` group which the test account is):
```shell
$ curl -X GET -H "Authorization: Bearer ${ACCESS_TOKEN}" \
  -H "Content-Type: application/json; charset=utf-8" \
  'http://localhost:8081/Patient/f16b5191-af47-4c5a-b9ca-71e0a4365824' 
```
```shell
$ curl -X PUT -H "Authorization: Bearer ${ACCESS_TOKEN}" \
  -H "Content-Type: application/json; charset=utf-8" \
  'http://localhost:8081/Patient/f16b5191-af47-4c5a-b9ca-71e0a4365824' \
  -d @Patient_f16b5191-af47-4c5a-b9ca-71e0a4365824_modified.json
```